@using System.Dynamic
@using BudgetApp.Core.Features.BankAccounts.Models
@using BudgetApp.Core.Features.Transactions.Commands
@using BudgetApp.Core.Features.Transactions.Models
@using MediatR
@inject IMediator Mediator
@inject DialogService DialogService

@if (showForm)
{
    <div style="display: flex; justify-content: center; align-items: center;">
        <RadzenTemplateForm TItem="ImportedTransactionScheme" Data="@TransactionScheme" Submit="@Submit">
            <div class="container">
                <div class="row">
                    <p>This is one of your imported transactions. Set value for each matching field, those values will be applied for all imported transactions</p>
                </div>
                <div class="row">
                    <div class="col-md-4 align-items-center d-flex">
                        <RadzenLabel Text="Date"/>
                    </div>
                    <div class="col-md-8">
                        <RadzenDropDown @bind-Value="TransactionScheme.CreateDateIndex" Data="@AvailableValues" TextProperty="Value" ValueProperty="Key"/>
                    </div>
                    <div class="col-md-4 align-items-center d-flex">
                        <RadzenLabel Text="Description"/>
                    </div>
                    <div class="col-md-8">
                        <RadzenDropDown @bind-Value="TransactionScheme.DescriptionIndex" Data="@AvailableValues" TextProperty="Value" ValueProperty="Key"/>
                    </div>
                    <div class="col-md-4 align-items-center d-flex">
                        <RadzenLabel Text="Amount"/>
                    </div>
                    <div class="col-md-8">
                        <RadzenDropDown @bind-Value="TransactionScheme.AmountIndex" Data="@AvailableValues" TextProperty="Value" ValueProperty="Key"/>
                    </div>
                    <div class="col-md-4 align-items-center d-flex">
                        <RadzenLabel Text="Bank account"/>
                    </div>
                    <div class="col-md-8">
                        <RadzenDropDown @bind-Value="TransactionScheme.BankAccountId" Data="@BankAccounts" TextProperty="Name" ValueProperty="Id"/>
                    </div>
                    <br/>
                    <RadzenButton ButtonType="ButtonType.Submit" Icon="save" Text="Save" Style="width: 30%"/>
                </div>
            </div>
        </RadzenTemplateForm>
    </div>
}


@code {

    [Parameter]
    public int BudgetId { get; set; }

    [Parameter]
    public int UserId { get; set; }

    [Parameter]
    public List<BankAccountModel> BankAccounts { get; set; }
    
    [Parameter]
    public ImportedTransactionScheme TransactionScheme { get; init; }

    [Parameter]
    public List<ExpandoObject> ImportedRows { get; set; }
    
    [Parameter]
    public EventCallback<bool> TransactionSchemeSaved { get; set; }
    
    private Dictionary<int, string> AvailableValues { get; } = new();

    private List<string> RequiredValues { get; set; }


    private bool showForm;

    protected override async Task OnInitializedAsync()
    {
        if (ImportedRows.Any())
        {
            PrepareRequiredValues();

            var exampleTransaction = ImportedRows.First();
            for (var i = 0; i < exampleTransaction.Count() - 1; i++)
            {
                
                var availableValue = exampleTransaction.ElementAt(i).Value;
                if (availableValue != null)
                    AvailableValues[i] = availableValue.ToString() ?? string.Empty;
            }

            showForm = true;
        }
    }

    private async Task Submit()
    {
        await TransactionSchemeSaved.InvokeAsync();
    }

    private void PrepareRequiredValues()
    {
        RequiredValues = new List<string>()
        {
            "Date",
            "Description",
            "Amount"
        };
    }

}